# Build, lint and test all targets

trigger:
  branches:
    include:
      - main
pr:
  autoCancel: true
  branches:
    include:
      - '*'

variables:
  - template: templates/common-variables.yml

stages:
  - stage: MainStage
    pool:
      vmImage: ${{variables.vmImage}}
    jobs:
      - job: Lint_And_Test
        timeoutInMinutes: 30
        steps:

          - template: templates/prepare-machine.yml

          - task: FlutterCommand@0
            displayName: 'Format code'
            inputs:
              arguments: 'format --set-exit-if-changed .'
              projectDirectory: '.'

          - task: FlutterCommand@0
            displayName: 'Analyze code'
            inputs:
              arguments: 'analyze'
              projectDirectory: '.'

          - task: FlutterCommand@0
            displayName: 'Test plugin'
            inputs:
              arguments: 'test --coverage'
              projectDirectory: '.'

          - task: FlutterCommand@0
            displayName: 'Test example app'
            inputs:
              arguments: 'test --coverage'
              projectDirectory: 'example'

          - task: FlutterCommand@0
            displayName: 'Build Android app'
            inputs:
              arguments: 'build appbundle'
              projectDirectory: 'example'

          - task: FlutterCommand@0
            displayName: 'Build iOS app'
            inputs:
              arguments: 'build ios --debug'
              projectDirectory: 'example'
